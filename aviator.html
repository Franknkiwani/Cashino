<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aviator Game</title>
  <style>
    body {
      background: #0f0f1a;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    #header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    #localTime {
      font-size: 18px;
      color: #aaa;
    }

    #balanceDisplay {
      font-size: 20px;
      color: #90ee90;
    }

    #aviatorGame {
      border: 2px solid #444;
      padding: 20px;
      width: 300px;
      border-radius: 15px;
      background: linear-gradient(145deg, #1f1f2e, #101018);
      box-shadow: 0 0 15px #1a1a2f;
      text-align: center;
      position: relative;
    }

    #aviatorMultiplier {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }

    .crash-low { color: red; }
    .crash-mid { color: orange; }
    .crash-high { color: greenyellow; }

    input, button {
      padding: 8px;
      border: none;
      border-radius: 5px;
      margin: 5px 0;
      width: 80%;
      box-sizing: border-box;
    }

    input[type="number"] {
      margin: 5px auto;
      display: block;
    }

    button {
      background: #ff004c;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    #crashHistory {
      margin-top: 15px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="header">
  <div id="localTime">--:--</div>
  <div id="balanceDisplay">Balance: $0.00</div>
</div>

<div id="aviatorGame">
  <div id="aviatorStatus">Waiting for next round...</div>
  <div id="aviatorMultiplier">x1.00</div>
  <input type="number" id="betAmount" placeholder="Enter bet ($0.10 min)" min="0.10" step="0.01" />
  <button id="startBtn">Start</button>
  <button id="cashoutBtn" style="display:none;">Cash Out</button>
  <div id="crashHistory">Last Crashes: </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  let userUID = null;
  let balance = 0;
  let multiplier = 1;
  let crashPoint = 1;
  let interval;
  let inGame = false;
  let hasCashedOut = false;
  let crashHistory = [];

  const balanceDisplay = document.getElementById("balanceDisplay");
  const multiplierEl = document.getElementById("aviatorMultiplier");
  const statusEl = document.getElementById("aviatorStatus");
  const startBtn = document.getElementById("startBtn");
  const cashoutBtn = document.getElementById("cashoutBtn");

  function updateLocalTime() {
    const now = new Date();
    let h = now.getHours(), m = now.getMinutes();
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    m = m < 10 ? '0' + m : m;
    document.getElementById("localTime").textContent = `${h}:${m} ${ampm}`;
  }

  setInterval(updateLocalTime, 10000);
  updateLocalTime();

  function updateBalanceDisplay() {
    balanceDisplay.textContent = "Balance: $" + balance.toFixed(2);
  }

  function fetchBalance() {
    const userRef = ref(db, 'users/' + userUID + '/balance');
    onValue(userRef, (snapshot) => {
      const val = snapshot.val();
      if (val !== null) {
        balance = parseFloat(val);
        updateBalanceDisplay();
      }
    });
  }

  function setBalance(val) {
    const userRef = ref(db, 'users/' + userUID);
    update(userRef, { balance: val.toFixed(2) });
  }

  function startGame() {
    if (inGame) return;
    const bet = parseFloat(document.getElementById("betAmount").value);
    if (isNaN(bet) || bet < 0.10 || bet > balance) {
      alert("Invalid bet. Minimum is $0.10.");
      return;
    }

    inGame = true;
    hasCashedOut = false;
    balance -= bet;
    setBalance(balance);
    updateBalanceDisplay();

    crashPoint = generateCrashPoint();
    multiplier = 1.00;
    statusEl.textContent = "Flying...";
    startBtn.style.display = "none";
    cashoutBtn.style.display = "inline-block";

    interval = setInterval(() => {
      multiplier += 0.01;
      multiplierEl.textContent = "x" + multiplier.toFixed(2);
      if (multiplier >= crashPoint) {
        endGame(bet);
      }
    }, 50);
0cashoutBtn.onclick = () => {
        if (!inGame || hasCashedOut) return;
        hasCashedOut = true;
        const payout = parseFloat(document.getElementById("betAmount").value) * multiplier;
        balance += payout;
        setBalance(balance);
        updateBalanceDisplay();
        statusEl.textContent = `You cashed out at x${multiplier.toFixed(2)}!`;
        clearInterval(interval);
        startBtn.style.display = "inline-block";
        cashoutBtn.style.display = "none";
        inGame = false;
        logCrash(multiplier);
        autoStartNextRound();
      };

      function endGame(bet) {
        clearInterval(interval);
        if (!hasCashedOut) {
          statusEl.textContent = `Crashed at x${crashPoint.toFixed(2)}! You lost $${bet.toFixed(2)}`;
        }
        startBtn.style.display = "inline-block";
        cashoutBtn.style.display = "none";
        inGame = false;
        logCrash(crashPoint);
        autoStartNextRound();
      }

      function logCrash(point) {
        crashHistory.unshift(point.toFixed(2));
        if (crashHistory.length > 5) crashHistory.pop();
        const historyHTML = crashHistory.map(p => {
          const mult = parseFloat(p);
          const className = mult < 2 ? 'crash-low' : mult < 5 ? 'crash-mid' : 'crash-high';
          return `<span class="${className}">x${p}</span>`;
        }).join(' ');
        document.getElementById("crashHistory").innerHTML = `Last Crashes: ${historyHTML}`;
      }

      function autoStartNextRound() {
        let countdown = 5;
        statusEl.textContent = `Next round in ${countdown}s...`;
        const timer = setInterval(() => {
          countdown--;
          if (countdown <= 0) {
            clearInterval(timer);
            if (!inGame) {
              startBtn.click();
            }
          } else {
            statusEl.textContent = `Next round in ${countdown}s...`;
          }
        }, 1000);
      }

      function generateCrashPoint() {
        const r = Math.random();
        if (r < 0.5) return parseFloat((1.00 + Math.random()).toFixed(2)); // 1x–2x
        if (r < 0.8) return parseFloat((2.0 + Math.random() * 3).toFixed(2)); // 2x–5x
        if (r < 0.95) return parseFloat((5.0 + Math.random() * 5).toFixed(2)); // 5x–10x
        return parseFloat((10.0 + Math.random() * 90).toFixed(2)); // 10x–100x
      }

      startBtn.onclick = startGame;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          userUID = user.uid;
          const userRef = ref(db, 'users/' + userUID);
          onValue(userRef, snapshot => {
            if (!snapshot.exists()) {
              set(userRef, { balance: 3.00 }); // free $3 for new user
            }
          });
          fetchBalance();
        } else {
          alert("Please log in to play Aviator.");
        }
      });
    </script>
  </body>
</html>