<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aviator Game</title>
  <style>
    body {
      background: #0f0f1a;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    #header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    #localTime {
      font-size: 18px;
      color: #aaa;
    }

    #balanceDisplay {
      font-size: 20px;
      color: #90ee90;
    }

    #aviatorGame {
      border: 2px solid #444;
      padding: 20px;
      width: 300px;
      border-radius: 15px;
      background: linear-gradient(145deg, #1f1f2e, #101018);
      box-shadow: 0 0 15px #1a1a2f;
      text-align: center;
      position: relative;
    }

    #aviatorMultiplier {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }

    .crash-low { color: red; }
    .crash-mid { color: orange; }
    .crash-high { color: greenyellow; }

    input, button {
      padding: 8px;
      border: none;
      border-radius: 5px;
      margin: 5px 0;
      width: 100%;
    }

    button {
      background: #ff004c;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    #crashHistory {
      margin-top: 15px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="header">
  <div id="localTime">--:--</div>
  <div id="balanceDisplay">Balance: $0.00</div>
</div>

<div id="aviatorGame">
  <div id="aviatorStatus">Waiting for next round...</div>
  <div id="aviatorMultiplier">x1.00</div>
  <input type="number" id="betAmount" placeholder="Enter bet ($1 min)" min="1" />
  <button id="startBtn">Start</button>
  <button id="cashoutBtn" style="display:none;">Cash Out</button>
  <div id="crashHistory">Last Crashes: </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  let userUID = null;
  let balance = 0;
  let multiplier = 1;
  let crashPoint = 1;
  let interval;
  let inGame = false;
  let hasCashedOut = false;
  let crashHistory = [];

  const balanceDisplay = document.getElementById("balanceDisplay");
  const multiplierEl = document.getElementById("aviatorMultiplier");
  const statusEl = document.getElementById("aviatorStatus");
  const startBtn = document.getElementById("startBtn");
  const cashoutBtn = document.getElementById("cashoutBtn");

  function updateLocalTime() {
    const now = new Date();
    let h = now.getHours(), m = now.getMinutes();
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    m = m < 10 ? '0' + m : m;
    document.getElementById("localTime").textContent = `${h}:${m} ${ampm}`;
  }

  setInterval(updateLocalTime, 10000);
  updateLocalTime();

  function updateBalanceDisplay() {
    balanceDisplay.textContent = "Balance: $" + balance.toFixed(2);
  }

  function fetchBalance() {
    const userRef = ref(db, 'users/' + userUID + '/balance');
    onValue(userRef, (snapshot) => {
      const val = snapshot.val();
      if (val !== null) {
        balance = parseFloat(val);
        updateBalanceDisplay();
      }
    });
  }

  function setBalance(val) {
    const userRef = ref(db, 'users/' + userUID);
    update(userRef, { balance: val.toFixed(2) });
  }

  function startGame() {
    if (inGame) return;
    const bet = parseFloat(document.getElementById("betAmount").value);
    if (isNaN(bet) || bet < 0.10 || bet > balance) {
      alert("Invalid bet.");
      return;
    }

    inGame = true;
    hasCashedOut = false;
    balance -= bet;
    setBalance(balance);
    updateBalanceDisplay();

    crashPoint = generateCrashPoint();
    multiplier = 1.00;
    statusEl.textContent = "Flying...";
    startBtn.style.display = "none";
    cashoutBtn.style.display = "inline-block";

    interval = setInterval(() => {
      multiplier += 0.01;
      multiplierEl.textContent = "x" + multiplier.toFixed(2);
      if (multiplier >= crashPoint) {
        endGame(bet);
      }
    }, 50);
  }

  function generateCrashPoint() {
    const r = Math.random();
    if (r < 0.6) return +(Math.random() * 0.5 + 1).toFixed(2);
    if (r < 0.9) return +(Math.random() * 4 + 1.5).toFixed(2);
    if (r < 0.99) return +(Math.random() * 10 + 5).toFixed(2);
    return +(Math.random() * 50 + 50).toFixed(2);
  }

  function endGame(bet) {
    clearInterval(interval);
    statusEl.textContent = "Crashed at x" + crashPoint.toFixed(2);
    updateCrashList(crashPoint);
    inGame = false;
    cashoutBtn.style.display = "none";
    setTimeout(() => {
      statusEl.textContent = "Waiting for next round...";
      startBtn.style.display = "inline-block";
    }, 3000);
  }

  function cashOut() {
    if (!inGame || hasCashedOut) return;
    hasCashedOut = true;
    const bet = parseFloat(document.getElementById("betAmount").value);
    const won = bet * multiplier;
    balance += won;
    setBalance(balance);
    updateBalanceDisplay();
    alert(`Cashed out at x${multiplier.toFixed(2)}! You won $${won.toFixed(2)}`);
  }

  function updateCrashList(newCrash) {
    crashHistory.unshift(newCrash);
    if (crashHistory.length > 5) crashHistory.pop();
    const histEl = document.getElementById("crashHistory");
    histEl.innerHTML = "Last Crashes: ";
    crashHistory.forEach(val => {
      let cls = val < 1.5 ? 'crash-low' : val < 5 ? 'crash-mid' : 'crash-high';
      histEl.innerHTML += `<span class="${cls}">x${val.toFixed(2)}</span> `;
    });
  }

  // Auth & Init
  onAuthStateChanged(auth, user => {
    if (user) {
      userUID = user.uid;
      const userRef = ref(db, 'users/' + userUID);
      onValue(userRef, snapshot => {
        if (!snapshot.exists()) {
          set(userRef, { balance: 3.00, email: user.email });
        }
      });
      fetchBalance();
    } else {
      alert("Please log in to play.");
    }
  });

  startBtn.onclick = startGame;
  cashoutBtn.onclick = cashOut;
</script>
</body>
</html>