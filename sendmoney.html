<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CyberPay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- EmailJS -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <!-- Firebase -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, get, update, onValue, child } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.appspot.com",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Initialize EmailJS
    window.addEventListener("DOMContentLoaded", () => {
      emailjs.init("SMeLjyyZsaSoBWGgZ");

      const balanceEl = document.getElementById("balance");
      const sendBtn = document.getElementById("sendBtn");
      const emailInput = document.getElementById("emailInput");
      const amountInput = document.getElementById("amountInput");
      const onlineUsersList = document.getElementById("onlineUsers");

      let currentUserEmail = "";
      let currentUserUID = "";

      onAuthStateChanged(auth, user => {
        if (user) {
          currentUserEmail = user.email;
          currentUserUID = user.uid;
          const earningsRef = ref(db, `users/${user.uid}/earnings`);
          onValue(earningsRef, snap => {
            const balance = snap.val() || 0;
            balanceEl.textContent = `$${balance.toFixed(2)}`;
          });

          // Fetch online users
          const onlineUsersRef = ref(db, 'onlineUsers');
          onValue(onlineUsersRef, snapshot => {
            onlineUsersList.innerHTML = ''; // Clear the list
            let count = 0;
            snapshot.forEach(childSnapshot => {
              if (count < 5) {
                const userData = childSnapshot.val();
                if (userData.email !== currentUserEmail) {
                  const listItem = document.createElement('li');
                  listItem.textContent = userData.email;
                  listItem.addEventListener('click', () => {
                    emailInput.value = userData.email;
                  });
                  onlineUsersList.appendChild(listItem);
                  count++;
                }
              }
            });
          });
        } else {
          alert("You're not logged in.");
          window.location.href = "/login.html";
        }
      });

      sendBtn.addEventListener("click", async () => {
        const recipient = emailInput.value.trim();
        const amount = parseFloat(amountInput.value);

        if (!recipient || isNaN(amount) || amount <= 0) {
          alert("Enter a valid email and amount.");
          return;
        }

        const senderRef = ref(db, `users/${currentUserUID}/earnings`);
        const senderSnap = await get(senderRef);
        const senderBalance = senderSnap.val() || 0;

        if (senderBalance < amount) {
          alert("Insufficient earnings.");
          return;
        }

        const usersRef = ref(db, "users");
        const usersSnap = await get(usersRef);
        let recipientUID = null;

        usersSnap.forEach(child => {
          if (child.val().email === recipient) {
            recipientUID = child.key;
          }
        });

        if (!recipientUID) {
          alert("Recipient not found.");
          return;
        }

        const recipientRef = ref(db, `users/${recipientUID}/earnings`);
        const recipientSnap = await get(recipientRef);
        const recipientBalance = recipientSnap.val() || 0;

        const updates = {};
        updates[`users/${currentUserUID}/earnings`] = senderBalance - amount;
        updates[`users/${recipientUID}/earnings`] = recipientBalance + amount;

        await update(ref(db), updates);

        emailjs.send("service_r5vg9am", "template_3bpotxr", {
          from_email: currentUserEmail,
          to_email: recipient
        }).then(() => {
          console.log("Email sent!");
        }).catch(err => {
          console.error("Email error:", err);
        });

        alert("Money sent successfully!");
        emailInput.value = "";
        amountInput.value = "";
      });
    });
  </script>
  <!-- Styles -->
  <style>
    * {
      -webkit-user-select: none;
      user-select: none;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: url('https://images.unsplash.com/photo-1565372912017-1a47a7b0b0c4') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }

    h1 {
      text-align: center;
      font-size: 2em;
      margin-bottom: 20px;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }

    .balance {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 30px;
    }

    input[type="email"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-bottom: 15px;
      font-size: 1em;
      background-color: rgba(255, 255, 255, 0.2);
      color: #fff;
      outline: none;
    }

    input::placeholder {
      color: #ccc;
    }

    #sendBtn {
      background-color: #0ff;
      border: none;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #sendBtn:hover {
      background-color: #00cccc;
    }

    ul#onlineUsers {
      list-style: none;
      margin-top: 20px;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
    }

    ul#onlineUsers li {
      padding: 8px 10px;
      background-color: rgba(255, 255, 255, 0.1);
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    ul#onlineUsers li:hover {
      background-color: rgba(0, 255, 255, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CyberPay</h1>
    <div class="balance">Earnings: <span id="balance">$0.00</span></div>
    <input type="email" id="emailInput" placeholder="Enter recipient's email">
    <input type="number" id="amountInput" placeholder="Enter amount to send" min="0.01" step="0.01">
    <button id="sendBtn">Send Money</button>

    <ul id="onlineUsers"></ul>
  </div>
</body>
</html>