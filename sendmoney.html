<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CyberPay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- EmailJS -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <style>
    * {
      -webkit-user-select: none;
      user-select: none;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #222, #111);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }

    h2 {
      margin-bottom: 30px;
      font-size: 24px;
      color: #00ffcc;
    }

    input {
      padding: 12px 16px;
      margin: 10px;
      border-radius: 8px;
      border: none;
      width: 260px;
      outline: none;
      font-size: 16px;
      background: #333;
      color: #fff;
    }

    button#sendBtn {
      background-color: #00ffcc;
      color: #000;
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
      transition: all 0.2s ease;
    }

    button#sendBtn:hover {
      background-color: #00e6b8;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <h2>Your Earnings: <span id="balance">$0.00</span></h2>
  <input id="emailInput" type="email" placeholder="Recipient Email">
  <input id="amountInput" type="number" placeholder="Amount to Send">
  <button id="sendBtn">Send</button>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.appspot.com",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    window.addEventListener("DOMContentLoaded", () => {
      emailjs.init("SMeLjyyZsaSoBWGgZ");

      const balanceEl = document.getElementById("balance");
      const sendBtn = document.getElementById("sendBtn");
      const emailInput = document.getElementById("emailInput");
      const amountInput = document.getElementById("amountInput");

      let currentUserEmail = "";
      let currentUserUID = "";

      onAuthStateChanged(auth, user => {
        if (user) {
          currentUserEmail = user.email;
          currentUserUID = user.uid;
          const earningsRef = ref(db, `users/${user.uid}/earnings`);
          onValue(earningsRef, snap => {
            const balance = snap.val() || 0;
            balanceEl.textContent = `$${balance.toFixed(2)}`;
          });
        } else {
          alert("You're not logged in.");
          window.location.href = "/login.html";
        }
      });

      sendBtn.addEventListener("click", async () => {
        const recipient = emailInput.value.trim();
        const amount = parseFloat(amountInput.value);

        if (!recipient || isNaN(amount) || amount <= 0) {
          alert("Enter a valid email and amount.");
          return;
        }

        const senderRef = ref(db, `users/${currentUserUID}/earnings`);
        const senderSnap = await get(senderRef);
        const senderBalance = senderSnap.val() || 0;

        if (senderBalance < amount) {
          alert("Insufficient earnings.");
          return;
        }

        const usersRef = ref(db, "users");
        const usersSnap = await get(usersRef);
        let recipientUID = null;

        usersSnap.forEach(child => {
          if (child.val().email === recipient) {
            recipientUID = child.key;
          }
        });

        if (!recipientUID) {
          alert("Recipient not found.");
          return;
        }

        const recipientRef = ref(db, `users/${recipientUID}/earnings`);
        const recipientSnap = await get(recipientRef);
        const recipientBalance = recipientSnap.val() || 0;

        const updates = {};
        updates[`users/${currentUserUID}/earnings`] = senderBalance - amount;
        updates[`users/${recipientUID}/earnings`] = recipientBalance + amount;

        await update(ref(db), updates);

        emailjs.send("service_r5vg9am", "template_3bpotxr", {
          from_email: currentUserEmail,
          to_email: recipient
        }).then(() => {
          console.log("Email sent!");
        }).catch(err => {
          console.error("Email error:", err);
        });

        alert("Money sent successfully!");
        emailInput.value = "";
        amountInput.value = "";
      });
    });
  </script>
</body>
</html>