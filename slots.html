<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online Tic Tac Toe</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #online-users div { margin: 10px 0; }
    img { vertical-align: middle; border-radius: 50%; }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 5px;
      margin-top: 20px;
    }
    .cell {
      width: 100px;
      height: 100px;
      font-size: 2em;
      text-align: center;
      line-height: 100px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #f0f0f0;
    }
    .cell:hover {
      background: #ddd;
    }
  </style>
</head>
<body>
  <h2>Multiplayer Tic Tac Toe</h2>
  <div id="login-section">
    <button id="login-btn">Login with Google</button>
  </div>

  <div id="online-users-section" style="display:none;">
    <h3>Online Users</h3>
    <div id="online-users"></div>
  </div>

  <div id="game-board" style="display:none;">
    <h3 id="status"></h3>
    <div class="board" id="board"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, onDisconnect, set, remove, onValue, update, off } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.appspot.com",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentGameRef = null;

    const loginBtn = document.getElementById("login-btn");
    loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        document.getElementById("login-section").style.display = "none";
        document.getElementById("online-users-section").style.display = "block";
        setupPresence(user);
        loadOnlineUsers();
        listenForGameRequests();
      }
    });

    function setupPresence(user) {
      const userRef = ref(db, '/onlineUsers/' + user.uid);
      const connRef = ref(db, '.info/connected');
      onValue(connRef, snap => {
        if (snap.val()) {
          set(userRef, {
            username: user.displayName,
            profilePic: user.photoURL,
            uid: user.uid
          });
          onDisconnect(userRef).remove();
        }
      });
    }

    function loadOnlineUsers() {
      const container = document.getElementById("online-users");
      onValue(ref(db, "/onlineUsers"), snapshot => {
        container.innerHTML = "";
        snapshot.forEach(child => {
          const user = child.val();
          if (user.uid !== currentUser.uid) {
            const div = document.createElement("div");
            div.innerHTML = `
              <img src="${user.profilePic}" width="30" height="30" />
              <b>${user.username}</b>
              <button onclick="invite('${user.uid}', '${user.username}')">Invite</button>
            `;
            container.appendChild(div);
          }
        });
      });
    }

    window.invite = (uid, name) => {
      const requestRef = ref(db, `/gameRequests/${uid}`);
      const gameId = `${currentUser.uid}_${uid}`;

      set(requestRef, {
        from: currentUser.uid,
        name: currentUser.displayName,
        gameId: gameId
      });

      alert(`Invitation sent to ${name}`);

      // Listen for game creation and auto-join as X
      const newGameRef = ref(db, `/games/${gameId}`);
      onValue(newGameRef, (snapshot) => {
        if (snapshot.exists()) {
          joinGame(gameId, "x");
          off(newGameRef);
        }
      });
    };

    function listenForGameRequests() {
      const requestRef = ref(db, `/gameRequests/${currentUser.uid}`);
      onValue(requestRef, snap => {
        if (snap.exists()) {
          const req = snap.val();
          const accept = confirm(`${req.name} invited you to play. Accept?`);
          if (accept) {
            const gameId = req.gameId;
            set(ref(db, `/games/${gameId}`), {
              players: {
                x: req.from,
                o: currentUser.uid
              },
              board: Array(9).fill(""),
              turn: "x"
            });
            remove(requestRef);
            joinGame(gameId, "o");
          } else {
            remove(requestRef);
          }
        }
      });
    }

    function joinGame(gameId, role) {
      document.getElementById("game-board").style.display = "block";
      const boardDiv = document.getElementById("board");
      const statusDiv = document.getElementById("status");
      currentGameRef = ref(db, `/games/${gameId}`);

      onValue(currentGameRef, snap => {
        const game = snap.val();
        if (!game) return;

        boardDiv.innerHTML = "";
        statusDiv.textContent = `You are '${role.toUpperCase()}'. Itâ€™s ${game.turn.toUpperCase()}'s turn`;

        game.board.forEach((cell, idx) => {
          const div = document.createElement("div");
          div.className = "cell";
          div.textContent = cell;
          div.onclick = () => {
            if (cell === "" && game.turn === role) {
              game.board[idx] = role;
              update(currentGameRef, {
                board: game.board,
                turn: role === "x" ? "o" : "x"
              });
            }
          };
          boardDiv.appendChild(div);
        });
      });
    }
  </script>
</body>
</html>