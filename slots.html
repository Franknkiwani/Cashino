<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Online Tic-Tac-Toe</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding-top: 50px;
    }
    h1 { margin-bottom: 20px; }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 5px;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: white;
      border: 2px solid #ccc;
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    #status { margin: 20px; font-size: 1.2rem; }
    #reset { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Online Tic-Tac-Toe</h1>
  <div class="board" id="board"></div>
  <div id="status">Joining game...</div>
  <button id="reset">Reset</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.appspot.com",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const resetBtn = document.getElementById('reset');

    let playerSymbol = null;
    let gameId = "defaultRoom"; // could be dynamic
    const gameRef = ref(db, `games/${gameId}`);

    const cells = [];
    const gameState = Array(9).fill("");
    let currentTurn = 'X';
    let isMyTurn = false;

    const renderBoard = () => {
      boardEl.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        cell.dataset.index = i;
        cell.textContent = gameState[i];
        cell.addEventListener('click', () => handleMove(i));
        boardEl.appendChild(cell);
        cells.push(cell);
      }
    };

    const joinGame = async () => {
      onValue(gameRef, (snapshot) => {
        const data = snapshot.val();

        if (!data) {
          set(gameRef, {
            board: Array(9).fill(""),
            currentTurn: 'X',
            players: { X: true },
            winner: null
          });
          playerSymbol = 'X';
          isMyTurn = true;
          statusEl.textContent = "You're X (your move)";
        } else {
          if (!data.players?.O) {
            update(gameRef, { "players/O": true });
            playerSymbol = 'O';
            isMyTurn = false;
            statusEl.textContent = "You're O (waiting...)";
          } else {
            playerSymbol = data.players.X ? 'O' : 'X'; // fallback
            statusEl.textContent = "Spectating";
          }
        }
      });

      onValue(ref(db, `games/${gameId}/board`), (snap) => {
        const board = snap.val();
        for (let i = 0; i < 9; i++) {
          gameState[i] = board[i];
        }
        renderBoard();
      });

      onValue(ref(db, `games/${gameId}/currentTurn`), (snap) => {
        currentTurn = snap.val();
        isMyTurn = currentTurn === playerSymbol;
        if (!playerSymbol) return;
        statusEl.textContent = isMyTurn ? `Your move (${playerSymbol})` : `Opponent's move (${currentTurn})`;
      });

      onValue(ref(db, `games/${gameId}/winner`), (snap) => {
        const winner = snap.val();
        if (winner) {
          isMyTurn = false;
          statusEl.textContent = winner === 'draw' ? "It's a draw!" : `${winner} wins!`;
        }
      });
    };

    const handleMove = async (index) => {
      if (!isMyTurn || gameState[index]) return;

      gameState[index] = playerSymbol;
      await update(gameRef, {
        board: gameState,
        currentTurn: playerSymbol === 'X' ? 'O' : 'X',
      });

      const winner = checkWinner();
      if (winner) {
        await update(gameRef, { winner });
      }
    };

    const checkWinner = () => {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let [a,b,c] of wins) {
        if (gameState[a] && gameState[a] === gameState[b] && gameState[a] === gameState[c]) {
          return gameState[a];
        }
      }
      if (!gameState.includes("")) return 'draw';
      return null;
    };

    resetBtn.addEventListener('click', () => {
      set(gameRef, {
        board: Array(9).fill(""),
        currentTurn: 'X',
        players: { X: true },
        winner: null
      });
    });

    joinGame();
    renderBoard();
  </script>
</body>
</html>