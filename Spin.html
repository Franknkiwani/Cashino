<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multiplayer Game</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      padding: 20px;
      margin: 0;
    }
    h1 { margin-bottom: 10px; }
    .user-card {
      padding: 10px;
      border: 1px solid #555;
      margin: 5px 0;
      background: #222;
      cursor: pointer;
      border-radius: 4px;
    }
    .user-card:hover {
      background: #333;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Multiplayer Game</h1>

  <div id="notLoggedIn" class="hidden">
    <p>You are not logged in. Please refresh after logging in through another page.</p>
  </div>

  <div id="userInfo" class="hidden">
    <p>Logged in as: <span id="username"></span></p>
    <h2>Online Users</h2>
    <div id="onlineUsers"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      onDisconnect,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const userInfo = document.getElementById("userInfo");
    const notLoggedIn = document.getElementById("notLoggedIn");
    const usernameSpan = document.getElementById("username");
    const onlineUsersDiv = document.getElementById("onlineUsers");

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        usernameSpan.textContent = user.displayName || user.email || "User";
        userInfo.classList.remove("hidden");

        const userRef = ref(db, "onlineUsers/" + user.uid);
        set(userRef, {
          uid: user.uid,
          name: user.displayName || user.email,
          status: "online"
        });
        onDisconnect(userRef).remove();

        listenForUsers();
        listenForRequests();
      } else {
        notLoggedIn.classList.remove("hidden");
      }
    });

    function listenForUsers() {
      const usersRef = ref(db, "onlineUsers");
      onValue(usersRef, snap => {
        onlineUsersDiv.innerHTML = "";
        snap.forEach(child => {
          const user = child.val();
          if (user.uid !== currentUser.uid) {
            const div = document.createElement("div");
            div.className = "user-card";
            div.textContent = user.name;
            div.onclick = () => sendGameRequest(user.uid);
            onlineUsersDiv.appendChild(div);
          }
        });
      });
    }

    function sendGameRequest(opponentUid) {
      const requestRef = ref(db, `gameRequests/${opponentUid}`);
      set(requestRef, {
        from: currentUser.uid,
        fromName: currentUser.displayName || currentUser.email,
        status: "pending"
      });
      alert(`Game request sent!`);
    }

    function listenForRequests() {
      const requestRef = ref(db, `gameRequests/${auth.currentUser.uid}`);
      onValue(requestRef, snap => {
        const req = snap.val();
        if (req && req.status === "pending") {
          const accept = confirm(`${req.fromName} wants to play. Accept?`);
          if (accept) {
            update(ref(db), {
              [`gameRequests/${auth.currentUser.uid}/status`]: "accepted",
              [`activeGames/${auth.currentUser.uid}`]: { vs: req.from },
              [`activeGames/${req.from}`]: { vs: auth.currentUser.uid }
            });
            remove(requestRef);
            alert("Game started! (Add game logic here)");
          } else {
            remove(requestRef);
            alert("Request declined.");
          }
        }
      });
    }
  </script>
</body>
</html>