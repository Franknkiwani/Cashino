<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spin to Win</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --glass-bg: rgba(0, 0, 0, 0.6);
      --primary: #00ffff;
      --accent: #ff00ff;
      --border-glow: 0 0 8px var(--primary);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #0e0e10;
      color: white;
      text-align: center;
      user-select: none;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--glass-bg);
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--primary);
    }

    .profile {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #username, #balance {
      font-weight: bold;
      color: var(--primary);
    }

    .wheel-container {
      margin-top: 60px;
      position: relative;
    }

    .wheel {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      border: 10px solid var(--primary);
      box-shadow: var(--border-glow);
      margin: 0 auto;
      background: conic-gradient(
        #0ff 0deg 45deg,
        #f0f 45deg 90deg,
        #0ff 90deg 135deg,
        #f0f 135deg 180deg,
        #0ff 180deg 225deg,
        #f0f 225deg 270deg,
        #0ff 270deg 315deg,
        #f0f 315deg 360deg
      );
      transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .pointer {
      width: 0; height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid var(--accent);
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
    }

    #spinBtn {
      margin-top: 40px;
      padding: 15px 30px;
      font-size: 18px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 10px var(--accent);
      transition: 0.3s;
    }

    #spinBtn:disabled {
      background: gray;
      box-shadow: none;
      cursor: not-allowed;
    }

    #result {
      margin-top: 25px;
      font-size: 20px;
      color: #0f0;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="profile">
      <span>Welcome, <span id="username">Loading...</span></span>
    </div>
    <div class="profile">
      Balance: <span id="balance">Loading...</span>
    </div>
  </div>

  <div class="wheel-container">
    <div class="pointer"></div>
    <div class="wheel" id="wheel"></div>
    <button id="spinBtn">SPIN</button>
    <div id="result"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const wheel = document.getElementById("wheel");
    const spinBtn = document.getElementById("spinBtn");
    const resultText = document.getElementById("result");
    const usernameEl = document.getElementById("username");
    const balanceEl = document.getElementById("balance");

    let userData = null;

    const prizes = [0.05, 0.1, 0.05, 0.1, 0.25, 0.5, 1, 3]; // weighted
    const weights = [25, 25, 20, 20, 5, 3, 1.5, 0.5]; // matches prizes

    function getWeightedPrize() {
      const total = weights.reduce((a, b) => a + b, 0);
      const rand = Math.random() * total;
      let cumulative = 0;
      for (let i = 0; i < prizes.length; i++) {
        cumulative += weights[i];
        if (rand < cumulative) return prizes[i];
      }
      return 0.05; // fallback
    }

    onAuthStateChanged(auth, user => {
      if (!user) return (window.location.href = "login.html");
      const uid = user.uid;

      const userRef = ref(db, "users/" + uid);
      onValue(userRef, snapshot => {
        if (snapshot.exists()) {
          userData = snapshot.val();
          usernameEl.textContent = userData.username || "Unknown";
          balanceEl.textContent = `$${(userData.earnings || 0).toFixed(2)}`;
        }
      });

      spinBtn.onclick = () => {
        spinBtn.disabled = true;
        const degree = 3600 + Math.floor(Math.random() * 360); // fast spin
        const prize = getWeightedPrize();
        wheel.style.transform = `rotate(${degree}deg)`;

        setTimeout(() => {
          resultText.textContent = `You won $${prize.toFixed(2)}!`;

          // update user balance
          const newEarnings = (userData.earnings || 0) + prize;
          update(ref(db, "users/" + uid), {
            earnings: newEarnings,
          });

          balanceEl.textContent = `$${newEarnings.toFixed(2)}`;
          spinBtn.disabled = false;
        }, 4000); // match transition duration
      };
    });
  </script>

</body>
</html>