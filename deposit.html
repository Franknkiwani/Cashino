<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deposit Money</title>
  <script src="https://www.paypal.com/sdk/js?client-id=AQlRInnmKjWmwHMNBE-z6za2NcSqhfaj3vD9x_AoQEoeVVtOxqvfjtGN9ixSVARi0IT9vhPeLo3AxwC5&currency=USD"></script>
</head>
<body>
  <h2>Deposit to Your Account</h2>
  <div>
    <label>Amount (USD):</label>
    <input type="number" id="amount" min="0.001" max="1000" step="0.001">
  </div>
  <br>
  <div id="paypal-button-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.appspot.com",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        renderPayPalButton();
      } else {
        alert("You must be logged in to deposit.");
      }
    });

    function renderPayPalButton() {
      paypal.Buttons({
        createOrder: (data, actions) => {
          const amount = parseFloat(document.getElementById('amount').value);
          if (!amount || amount < 0.001 || amount > 1000) {
            alert("Enter an amount between $0.001 and $1000.");
            throw new Error("Invalid amount");
          }
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: amount.toFixed(3)
              }
            }]
          });
        },
        onApprove: async (data, actions) => {
          const amount = parseFloat(document.getElementById('amount').value);
          const details = await actions.order.capture();

          const userRef = doc(db, "users", currentUser.uid);
          const userSnap = await getDoc(userRef);
          const currentBalance = userSnap.exists() && userSnap.data().balance ? userSnap.data().balance : 0;

          await updateDoc(userRef, {
            balance: currentBalance + amount
          });

          alert(`$${amount.toFixed(3)} deposited successfully!`);
        },
        onError: (err) => {
          console.error("PayPal error:", err);
          alert("There was a problem with the payment. Check the console for more details.");
        }
      }).render('#paypal-button-container');
    }
  </script>
</body>
</html>